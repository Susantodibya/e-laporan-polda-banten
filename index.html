<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>e-Laporan Kegiatan SDM Polda Banten</title>

    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- html2pdf.js CDN for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary-blue: #4A90E2;
            --light-blue: #EBF5FF;
            --dark-blue: #0056b3;
            --text-dark: #333333;
            --text-medium: #555555;
            --bg-light: #F0F2F5;
            --content-bg: #FFFFFF;
            --border-light: #E0E0E0;
            --shadow-light: rgba(0, 0, 0, 0.08);
            --shadow-medium: rgba(0, 0, 0, 0.15);
            --red-danger: #dc3545;
            --gemini-green: #34A853;
            --orange-edit: #ffc107;
            --dark-orange-edit: #e0a800;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            padding: 20px;
            line-height: 1.6;
            color: var(--text-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h2, h3 {
            text-align: center;
            color: var(--primary-blue);
            margin-bottom: 25px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        form, #output, #history-section {
            background-color: var(--content-bg);
            padding: 30px;
            max-width: 750px;
            width: 100%;
            margin: 20px auto;
            box-shadow: 0 5px 15px var(--shadow-light);
            border-radius: 12px;
            border: 1px solid var(--border-light);
        }
        
        #user-info {
            background-color: var(--content-bg);
            padding: 10px 20px;
            max-width: 750px;
            width: 100%;
            margin: 0 auto 20px;
            box-shadow: 0 5px 15px var(--shadow-light);
            border-radius: 12px;
            border: 1px solid var(--border-light);
            text-align: center;
            font-size: 0.9em;
            color: var(--text-medium);
        }

        form {
            margin-top: 0;
        }

        label {
            font-weight: 500;
            display: block;
            margin-top: 20px;
            margin-bottom: 5px;
            color: var(--text-medium);
            font-size: 0.95em;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            color: var(--text-dark);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-blue);
            outline: none;
            box-shadow: 0 0 0 3px var(--light-blue);
        }

        textarea {
            min-height: 140px;
            resize: vertical;
        }

        button {
            padding: 12px 25px;
            background: linear-gradient(135deg, var(--primary-blue) 0%, #6A9EEB 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            background: linear-gradient(135deg, var(--dark-blue) 0%, var(--primary-blue) 100%);
            box-shadow: 0 6px 15px var(--shadow-medium);
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .button-group {
            text-align: center;
            margin-top: 30px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
        }

        #output {
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 1em;
            color: var(--text-dark);
            position: relative;
            overflow: hidden;
            min-height: 200px;
        }

        #output p, #output ul, #output li {
            margin: 0;
            padding: 0;
            line-height: inherit;
        }

        #output .bold-text {
            font-weight: bold;
        }

        #history-section {
            margin-bottom: 40px;
        }

        .history-item {
            border: 1px solid var(--border-light);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 10px;
            background-color: var(--bg-light);
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .history-item strong {
            color: var(--primary-blue);
        }

        .history-item-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .history-item-buttons button {
            margin: 0;
            padding: 8px 15px;
            font-size: 0.9em;
            box-shadow: none;
            background: var(--primary-blue);
        }

        .history-item-buttons button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .history-item-buttons button.delete-btn {
            background: var(--red-danger);
        }
        .history-item-buttons button.delete-btn:hover {
            background: #c82333;
        }
        .history-item-buttons button.edit-btn {
            background: var(--orange-edit);
        }
        .history-item-buttons button.edit-btn:hover {
            background: var(--dark-orange-edit);
        }

        #daftar-hadir-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #daftar-hadir-container > div {
            display: flex;
            align-items: center;
            gap: 5px;
            /* Make it draggable */
            cursor: grab;
        }
        #daftar-hadir-container > div.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        #daftar-hadir-container input.hadir {
            flex-grow: 1;
            margin-bottom: 0;
        }

        button.delete-participant-btn {
            margin: 0;
            padding: 5px 10px;
            font-size: 0.8em;
            min-width: 40px;
            height: 40px;
            border-radius: 50%;
            box-shadow: none;
            background: var(--red-danger);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.2s ease;
        }

        button.delete-participant-btn:hover {
            background: #c82333;
            transform: none;
            box-shadow: none;
        }

        button.gemini-btn {
            background: linear-gradient(135deg, var(--gemini-green) 0%, #5CB85C 100%);
            box-shadow: 0 4px 10px rgba(52, 168, 83, 0.2);
        }
        button.gemini-btn:hover {
            background: linear-gradient(135deg, #288F44 0%, var(--gemini-green) 100%);
            box-shadow: 0 6px 15px rgba(52, 168, 83, 0.3);
        }
        button.gemini-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        hr {
            border: none;
            border-top: 1px dashed var(--border-light);
            margin: 40px auto;
            width: 80%;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--content-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 25px var(--shadow-medium);
            max-width: 450px;
            width: 90%;
            text-align: center;
            transform: translateY(-20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .modal-overlay.visible .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        .modal-content h4 {
            color: var(--primary-blue);
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.4em;
            font-weight: 600;
        }

        .modal-content p {
            color: var(--text-medium);
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .modal-content .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .modal-content .modal-buttons button {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 500;
            box-shadow: none;
            margin: 0;
        }

        .modal-content .modal-buttons button.confirm-btn {
            background: linear-gradient(135deg, var(--primary-blue) 0%, #6A9EEB 100%);
            color: white;
        }
        .modal-content .modal-buttons button.confirm-btn:hover {
            background: linear-gradient(135deg, var(--dark-blue) 0%, var(--primary-blue) 100%);
        }

        .modal-content .modal-buttons button.cancel-btn {
            background: #f0f0f0;
            color: var(--text-dark);
            border: 1px solid var(--border-light);
        }
        .modal-content .modal-buttons button.cancel-btn:hover {
            background: #e0e0e0;
        }

        /* Filter section styling */
        .filter-section {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: flex-end;
        }

        .filter-section .filter-group {
            flex: 1;
            min-width: 180px;
        }

        .filter-section label {
            margin-top: 0;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .filter-section input,
        .filter-section select {
            margin-bottom: 0;
        }

        .filter-section button {
            margin: 0;
            padding: 10px 20px;
            font-size: 0.9em;
            align-self: flex-end;
        }

        /* Watermark style for PDF */
        .pdf-watermark {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 12px;
            color: rgba(0, 0, 0, 0.3);
            font-weight: bold;
            transform: rotate(-15deg);
            transform-origin: 100% 100%;
            z-index: 9999;
        }

        /* Watermark style for Web Display */
        .web-watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-25deg);
            font-size: 3em;
            color: rgba(0, 0, 0, 0.08);
            font-weight: bold;
            pointer-events: none;
            white-space: nowrap;
            z-index: 1;
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            form, #output, #history-section, #user-info {
                padding: 20px;
                margin: 15px auto;
            }
            h2, h3 {
                font-size: 1.5em;
                margin-bottom: 20px;
            }
            button {
                width: calc(50% - 10px);
                margin: 5px;
            }
            .button-group {
                gap: 5px;
            }
            .history-item-buttons button {
                width: calc(50% - 4px);
            }
            .filter-section {
                flex-direction: column;
                align-items: stretch;
            }
            .filter-section .filter-group {
                min-width: unset;
                width: 100%;
            }
            .filter-section button {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 0;
            }
            form, #output, #history-section, #user-info {
                padding: 20px 15px;
                margin: 0 auto;
                width: 100%;
                border-radius: 0;
                box-shadow: none;
            }
            h2, h3 {
                font-size: 1.6em;
                margin-bottom: 15px;
                padding: 0 10px;
            }
            label {
                font-size: 1em;
            }
            input, select, textarea {
                padding: 15px;
                font-size: 1.1em;
            }
            button {
                width: 100%;
                margin: 5px 0;
                padding: 15px 25px;
                font-size: 1.05em;
            }
            .button-group {
                gap: 8px;
            }
            .history-item-buttons button {
                width: 100%;
                padding: 12px;
                font-size: 0.95em;
            }
            .web-watermark {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>

    <h2>e-Laporan Kegiatan SDM Polda Banten</h2>
    <div id="user-info"></div>

    <form id="reportForm">
        <input type="hidden" id="editingReportId" value="">

        <label for="jenis">Jenis Kegiatan:</label>
        <input type="text" id="jenis" placeholder="Contoh: Rapat, Supervisi, Kunjungan" required />

        <label for="kepada">Kepada Yth:</label>
        <select id="kepada">
            <option value="Kapolda Banten">Kapolda Banten</option>
            <option value="Wakapolda Banten">Wakapolda Banten</option>
            <option value="Karo SDM Polda Banten" selected>Karo SDM Polda Banten</option>
            <option value="Irwasda Polda Banten">Irwasda Polda Banten</option>
        </select>

        <label for="dari">Dari:</label>
        <select id="dari">
            <option value="Kapolda Banten">Kapolda Banten</p>
            <option value="Karo SDM Polda Banten">Karo SDM Polda Banten</option>
            <option value="Kabagbinkar Ro SDM Polda Banten" selected>Kabagbinkar Ro SDM Polda Banten</option>
            <option value="Kasubbagmutjab Bag Binkar">Kasubbagmutjab Bag Binkar</option>
        </select>

        <label for="tanggal">Hari, Tanggal:</label>
        <input type="date" id="tanggal" required />

        <label for="waktu">Waktu:</label>
        <input type="time" id="waktu" required />

        <label for="tempat">Tempat:</label>
        <input type="text" id="tempat" placeholder="Contoh: Ruang Kerja Kabagbinkar" required />

        <label for="pimpinan">Pimpinan Kegiatan:</label>
        <input list="pimpinan-options" id="pimpinan" placeholder="Ketik atau pilih jabatan" required />
        <datalist id="pimpinan-options">
            <option value="Kapolda Banten"></option>
            <option value="Karo SDM Polda Banten"></option>
            <option value="Kabagbantanas Set NCB Interpol Indonesia"></option>
            <option value="Dirbintibmas Baharkam Polri"></option>
        </datalist>

        <label>Dihadiri oleh:</label>
        <div id="daftar-hadir-container">
            <!-- Default participant input will be added by JavaScript on load/reset -->
        </div>
        <datalist id="daftar-hadir">
            <option value="Kasubbagmutjab Bag Binkar Ro SDM Polda Banten"></option>
            <option value="Staff Bagbinkar Ro SDM Polda Banten"></option>
            <option value="Kasubbagsisminkar"></option>
            <option value="Kabag Dalpers"></option>
            <option value="Auditor Kepolisian Madya Tk. III Itwasda Polda Banten"></option>
            <option value="Dansatbrimob Polda Banten"></option>
            <option value="Dirintelkam Polda Banten"></option>
            <option value="Dirlantas Polda Banten"></option>
            <option value="Dirpamobvit Polda Banten"></option>
            <option value="Dirpolairud Polda Banten"></option>
            <option value="Dirreskrimum Polda Banten"></option>
            <option value="Dirreskrimsus Polda Banten"></option>
            <option value="Dirresnarkoba Polda Banten"></option>
            <option value="Dirsamapta Polda Banten"></option>
            <option value="Gadik Madya SPN Polda Banten"></option>
            <option value="Irwasda Polda Banten"></option>
            <option value="Ka SPN Polda Banten"></option>
            <option value="Kabagbekum Rolog Polda Banten"></option>
            <option value="Kagabbinopsnal Ditsabhara Polda Banten"></option>
            <option value="Kabagbinopsnal Ditsamapta Polda Banten"></option>
            <option value="Kabagdalops Roops Polda Banten"></option>
            <option value="Kabaginfolog Rolog Polda Banten"></option>
            <option value="Kabagops Polresta Serang Kota Polda Banten"></option>
            <option value="Kabagrenprogar Rorena Polda Banten"></option>
            <option value="Kabagstrajemen Rorena Polda Banten"></option>
            <option value="Kabid TIK Polda Banten"></option>
            <option value="Kabiddokkes Polda Banten"></option>
            <option value="Kabidhumas Polda Banten"></option>
            <option value="Kabidkeu Polda Banten"></option>
            <option value="Kabidkum Polda Banten"></option>
            <option value="Kabidpropam Polda Banten"></option>
            <option value="Karorena Polda Banten"></option>
            <option value="Karolog Polda Banten"></option>
            <option value="Karoops Polda Banten"></option>
            <option value="Karo SDM Polda Banten"></option>
            <option value="Kapolda Banten"></option>
            <option value="Kapolresta Serang Kota Polda Banten"></option>
            <option value="Kapolresta Tangerang Polda Banten"></option>
            <option value="Kasubbagrenmin Ditresnarkoba Polda Banten"></option>
            <option value="Kasubbid PID Bidhumas Polda Banten"></option>
            <option value="Kasubbidmulmed Bidhumas Polda Banten"></option>
            <option value="Kasubdit 1 Ditintelkam Polda Banten"></option>
            <option value="Kasubdit 2 Ditreskrimsus Polda Banten"></option>
            <option value="Kasubdit 2 Ditresnarkoba Polda Banten"></option>
            <option value="Kasubdit 3 Ditintelkam Polda Banten"></option>
            <option value="Kasubdit Bhabinkamtibmas Ditbinmas Polda Banten"></option>
            <option value="Kasubdit Bintibsos Ditbinmas Polda Banten"></option>
            <option value="Kasubdit Gakkum Ditlantas Polda Banten"></option>
            <option value="Pamen Ditpamobvit Polda Banten"></option>
            <option value="Pamen Polda Banten"></option>
            <option value="Penata Kebijakan Kapolri Madya Tk. III Polda Banten"></option>
            <option value="Penyidik Madya Ditresnarkoba Polda Banten"></option>
            <option value="Wadirbinmas Polda Banten"></option>
            <option value="Wakapolda Banten"></option>
            <option value="Kapolres Cilegon Polda Banten"></option>
            <option value="Kapolres Pandeglang Polda Banten"></option>
            <option value="Kapolres Serang Polda Banten"></option>
            <option value="Paurmutjab Bagbinkar Ro SDM Polda Banten"></option>
            <option value="Staff Biro SDM Polda Banten"></option>
            <option value="Staff Bagbinkar SDM Polda Banten"></option>
        </datalist>
        <button type="button" onclick="tambahPeserta()">+ Tambah Peserta</button>

        <label for="hasil">Hasil yang Didapat:</label>
        <textarea id="hasil" placeholder="Tulis ringkasan hasil kegiatan secara poin" required></textarea>
        <button type="button" id="elaborateHasilBtn" class="gemini-btn" onclick="elaborateHasil()">âœ¨ Perluas Hasil</button>


        <label for="sapaan">Sapaan Akhir Kepada:</label>
        <select id="sapaan">
            <option value="Komandan" selected>Komandan</option>
            <option value="Jenderal">Jenderal</option>
        </select>

        <div class="button-group">
            <button type="button" id="mainActionButton" onclick="generateLaporan()">Buat Laporan</button>
            <button type="button" id="cancelEditButton" style="display:none;" onclick="cancelEdit()">Batalkan Edit</button>
            <button type="button" onclick="downloadPDF()">Download PDF</button>
            <button type="button" onclick="copyLaporan()">Copy Laporan</button>
            <button type="button" onclick="hapusLaporan()">Hapus Laporan</button>
        </div>
    </form>

    <hr>

    <h3>Hasil Laporan:</h3>
    <div id="output">
        <div id="reportDisplayArea"></div>
    </div>

    <hr>

    <h3>Riwayat Laporan:</h3>
    <div id="history-section">
        <div class="filter-section">
            <div class="filter-group">
                <label for="searchQuery">Cari Laporan:</label>
                <input type="text" id="searchQuery" placeholder="Kata kunci..." onkeyup="renderHistory()">
            </div>
            <div class="filter-group">
                <label for="filterJenis">Jenis Kegiatan:</label>
                <select id="filterJenis" onchange="renderHistory()">
                    <option value="">Semua</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="filterKepada">Kepada Yth:</label>
                <select id="filterKepada" onchange="renderHistory()">
                    <option value="">Semua</option>
                </select>
            </div>
            <button onclick="renderHistory()">Terapkan Filter</button>
        </div>
        <div id="history">
            <!-- Report history will be displayed here -->
            <p>Memuat riwayat...</p>
        </div>
        <div class="button-group">
            <button type="button" onclick="clearAllHistory()" class="delete-btn">Bersihkan Semua Riwayat</button>
        </div>
    </div>

    <!-- Custom Modal Structure -->
    <div id="customModal" class="modal-overlay">
        <div class="modal-content">
            <h4 id="modalTitle"></h4>
            <p id="modalMessage"></p>
            <div class="modal-buttons">
                <button id="modalConfirmBtn" class="confirm-btn">OK</button>
                <button id="modalCancelBtn" class="cancel-btn">Batal</button>
            </div>
        </div>
    </div>

    <!-- Firestore SDK scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, getDoc, onSnapshot, query, where, getDocs, setLogLevel, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase and user state
        let db;
        let auth;
        let userId = null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(__firebase_config);
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Global variable to store the confirm callback
        let confirmCallback = null;
        let dragSrcEl = null;

        /**
         * Displays a custom modal dialog.
         * @param {string} message - The message to display in the modal.
         * @param {'alert'|'confirm'} type - The type of modal ('alert' or 'confirm').
         * @param {function} [onConfirm] - Callback function to execute if 'confirm' is clicked.
         */
        function showModal(message, type, onConfirm = null) {
            const modal = document.getElementById('customModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalConfirmBtn = document.getElementById('modalConfirmBtn');
            const modalCancelBtn = document.getElementById('modalCancelBtn');

            modalMessage.textContent = message;
            confirmCallback = onConfirm;

            if (type === 'alert') {
                modalTitle.textContent = 'Informasi';
                modalConfirmBtn.textContent = 'OK';
                modalConfirmBtn.style.display = 'inline-block';
                modalConfirmBtn.onclick = hideModal;
                modalCancelBtn.style.display = 'none';
            } else if (type === 'confirm') {
                modalTitle.textContent = 'Konfirmasi';
                modalConfirmBtn.textContent = 'Ya';
                modalConfirmBtn.style.display = 'inline-block';
                modalConfirmBtn.onclick = () => {
                    if (confirmCallback) {
                        confirmCallback();
                    }
                    hideModal();
                };
                modalCancelBtn.textContent = 'Tidak';
                modalCancelBtn.style.display = 'inline-block';
                modalCancelBtn.onclick = hideModal;
            }
            modal.classList.add('visible');
        }

        /**
         * Hides the custom modal dialog.
         */
        function hideModal() {
            document.getElementById('customModal').classList.remove('visible');
            confirmCallback = null;
        }

        // --- Core Application Functions ---
        
        // Function to add more participant input fields
        function tambahPeserta() {
            const container = document.getElementById("daftar-hadir-container");
            const newParticipantDiv = document.createElement("div");
            newParticipantDiv.setAttribute('draggable', 'true');
            newParticipantDiv.style.display = "flex";
            newParticipantDiv.style.alignItems = "center";
            newParticipantDiv.style.gap = "5px";

            const input = document.createElement("input");
            input.setAttribute("list", "daftar-hadir");
            input.className = "hadir";
            input.placeholder = "Ketik atau pilih peserta";
            input.style.marginBottom = "0";

            const removeBtn = document.createElement("button");
            removeBtn.textContent = "X";
            removeBtn.className = "delete-participant-btn";
            removeBtn.onclick = function() {
                container.removeChild(newParticipantDiv);
            };

            newParticipantDiv.appendChild(input);
            newParticipantDiv.appendChild(removeBtn);
            container.appendChild(newParticipantDiv);
        }

        // Function to get current form data
        function getFormData() {
            const jenis = document.getElementById("jenis").value.trim();
            const kepada = document.getElementById("kepada").value;
            const dari = document.getElementById("dari").value;
            const tanggalInput = document.getElementById("tanggal").value;
            const waktuInput = document.getElementById("waktu").value;
            const tempat = document.getElementById("tempat").value.trim();
            const pimpinan = document.getElementById("pimpinan").value.trim();
            const hasil = document.getElementById("hasil").value.trim();
            const sapaan = document.getElementById("sapaan").value;

            const hadirElements = document.querySelectorAll(".hadir");
            const daftarHadirArray = Array.from(hadirElements)
                .map(el => el.value.trim())
                .filter(Boolean);

            return {
                jenis: jenis,
                kepada: kepada,
                dari: dari,
                tanggal: tanggalInput,
                waktu: waktuInput,
                tempat: tempat,
                pimpinan: pimpinan,
                hasil: hasil,
                sapaan: sapaan,
                peserta: daftarHadirArray
            };
        }

        // Function to validate form data
        function validateFormData(formData) {
            if (!formData.jenis || !formData.tanggal || !formData.waktu || !formData.tempat || !formData.pimpinan || !formData.hasil) {
                showModal("Mohon lengkapi semua kolom penting.", 'alert');
                return false;
            }
            return true;
        }

        // Function to format report content
        function formatReportContent(formData) {
            const dateObj = new Date(formData.tanggal + 'T00:00:00');
            const formattedTanggal = dateObj.toLocaleDateString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            const formattedWaktu = `${formData.waktu} WIB s.d Selesai`;

            let hadirListFormatted = "";
            if (formData.peserta.length > 0) {
                hadirListFormatted = formData.peserta.map((item, index) => `${index + 1}. ${item}`).join('\n');
            } else {
                hadirListFormatted = "Tidak ada yang hadir.";
            }

            // Create a formatted string for the report, using a div wrapper for the content to apply styles
            return `<div>
                <span class="bold-text">Kepada Yth :</span> ${formData.kepada}<br>
                <span class="bold-text">Dari :</span> ${formData.dari}<br><br>
                Assalamualaikum Wr. Wb.
                <br>
                Selamat siang ${formData.sapaan}. Mohon izin melaporkan pelaksanaan ${formData.jenis} dengan rincian sebagai berikut:
                <br><br>
                <span class="bold-text">Pelaksanaan Kegiatan:</span><br>
                1. Hari, Tanggal: ${formattedTanggal};<br>
                2. Pukul : ${formattedWaktu};<br>
                3. Tempat : ${formData.tempat};<br>
                4. Pimpinan Kegiatan : ${formData.pimpinan}.
                <br><br>
                <span class="bold-text">Dihadiri oleh:</span><br>
                ${hadirListFormatted.replace(/\n/g, '<br>')}
                <br><br>
                <span class="bold-text">Hasil yang Didapat:</span><br>
                ${formData.hasil.replace(/\n/g, '<br>')}
                <br><br>
                <span class="bold-text">Penutup:</span><br>
                Kegiatan berjalan dengan tertib dan lancar, Demikian yang dapat kami laporkan kepada ${formData.sapaan}, dan kami haturkan terima kasih.
                <br>
                (dokumentasi terlampir)
                <br><br>
                Wassalamu'alaikum Wr. Wb.
                <br><br>
                <span class="bold-text">Biro SDM Polda Banten</span><br>
                <span class="bold-text">Mewujudkan SDM Polri Yang Unggul</span>
            </div>`;
        }
        
        // Function to generate a new report and save it to Firestore
        async function generateLaporan() {
            const formData = getFormData();
            if (!validateFormData(formData)) {
                return;
            }

            const reportContent = formatReportContent(formData);
            document.getElementById("reportDisplayArea").innerHTML = reportContent;
            addWebWatermark();

            await saveToHistory(formData);
            showModal("Laporan berhasil dibuat!", 'alert');
            resetForm();
        }

        // Function to update an existing report in Firestore
        async function updateLaporan() {
            const editingId = document.getElementById("editingReportId").value;
            if (!editingId) {
                showModal("Tidak ada laporan yang sedang diedit.", 'alert');
                return;
            }

            const formData = getFormData();
            if (!validateFormData(formData)) {
                return;
            }

            const reportContent = formatReportContent(formData);
            document.getElementById("reportDisplayArea").innerHTML = reportContent;
            addWebWatermark();

            try {
                const reportRef = doc(db, 'artifacts', appId, 'users', userId, 'reports', editingId);
                await setDoc(reportRef, {
                    ...formData,
                    content: reportContent,
                    timestamp: new Date()
                }, { merge: true });
                showModal("Laporan berhasil diperbarui!", 'alert');
                resetForm();
            } catch (e) {
                console.error("Error updating document: ", e);
                showModal("Gagal memperbarui laporan: " + e.message, 'alert');
            }
        }

        // Function to reset the form and action buttons
        function resetForm() {
            document.getElementById("reportForm").reset();
            document.getElementById("editingReportId").value = "";
            document.getElementById("mainActionButton").textContent = "Buat Laporan";
            document.getElementById("mainActionButton").onclick = generateLaporan;
            document.getElementById("cancelEditButton").style.display = "none";
            const container = document.getElementById("daftar-hadir-container");
            container.innerHTML = '';
            addDefaultParticipantInput();
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const tanggalInput = document.getElementById('tanggal');
            if (tanggalInput) {
                tanggalInput.value = `${year}-${month}-${day}`;
            }
            removeWebWatermark();
            document.getElementById("reportDisplayArea").innerHTML = '';
        }

        // Helper function to add the default participant input
        function addDefaultParticipantInput() {
            const container = document.getElementById("daftar-hadir-container");
            const defaultParticipantDiv = document.createElement("div");
            defaultParticipantDiv.setAttribute('draggable', 'true');
            defaultParticipantDiv.style.display = "flex";
            defaultParticipantDiv.style.alignItems = "center";
            defaultParticipantDiv.style.gap = "5px";

            const defaultInput = document.createElement("input");
            defaultInput.setAttribute("list", "daftar-hadir");
            defaultInput.className = "hadir";
            defaultInput.value = "Kasubbagmutjab Bag Binkar Ro SDM Polda Banten";
            defaultInput.style.marginBottom = "0";

            defaultParticipantDiv.appendChild(defaultInput);
            container.appendChild(defaultParticipantDiv);
        }

        // Function to cancel editing and reset form
        function cancelEdit() {
            showModal("Yakin ingin membatalkan pengeditan? Perubahan yang belum disimpan akan hilang.", 'confirm', () => {
                resetForm();
                showModal("Pengeditan dibatalkan. Formulir diatur ulang.", 'alert');
            });
        }

        // Function to download the report as PDF
        function downloadPDF() {
            const element = document.getElementById("reportDisplayArea");
            if (!element.innerHTML.trim()) {
                showModal("Tidak ada laporan yang bisa diunduh.", 'alert');
                return;
            }

            const printElement = document.createElement('div');
            printElement.innerHTML = element.innerHTML;
            const watermark = document.createElement('div');
            watermark.className = 'pdf-watermark';
            watermark.textContent = 'Bripda MEEP';
            printElement.appendChild(watermark);
            const pdfWatermarkStyle = document.createElement('style');
            pdfWatermarkStyle.textContent = `
                .pdf-watermark {
                    position: absolute;
                    bottom: 20px;
                    right: 20px;
                    font-size: 12px;
                    color: rgba(0, 0, 0, 0.3);
                    font-weight: bold;
                    transform: rotate(-15deg);
                    transform-origin: 100% 100%;
                    z-index: 9999;
                }
            `;
            printElement.appendChild(pdfWatermarkStyle);

            html2pdf().from(printElement).set({
                margin: 0.5,
                filename: 'laporan-kegiatan-sdm.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            }).save();
        }

        // Function to copy the report to clipboard
        function copyLaporan() {
            const outputElement = document.getElementById("reportDisplayArea");
            if (!outputElement.innerHTML.trim()) {
                showModal("Belum ada laporan untuk disalin.", 'alert');
                return;
            }
            const tempElement = document.createElement("textarea");
            tempElement.value = outputElement.innerText;
            document.body.appendChild(tempElement);
            tempElement.select();
            document.execCommand("copy");
            document.body.removeChild(tempElement);
            showModal("Laporan berhasil disalin ke clipboard!", 'alert');
        }

        // Function to clear the displayed report
        function hapusLaporan() {
            showModal("Yakin ingin menghapus laporan yang ditampilkan?", 'confirm', () => {
                document.getElementById("reportDisplayArea").innerHTML = "";
                removeWebWatermark();
                showModal("Laporan berhasil dihapus.", 'alert');
            });
        }

        // --- History & Firestore Functions ---

        // Function to save a report to Firestore
        async function saveToHistory(formData) {
            try {
                const docRef = await addDoc(collection(db, 'artifacts', appId, 'users', userId, 'reports'), {
                    ...formData,
                    content: formatReportContent(formData),
                    timestamp: new Date()
                });
                console.log("Document written with ID: ", docRef.id);
            } catch (e) {
                console.error("Error adding document: ", e);
                showModal("Gagal menyimpan laporan. Mohon cek koneksi internet Anda.", 'alert');
            }
        }

        // Function to render the history of reports with search and filter
        function renderHistory() {
            if (!userId) {
                console.log("User ID not available yet. Waiting for authentication...");
                return;
            }

            const historyContainer = document.getElementById("history");
            const searchQuery = document.getElementById('searchQuery').value.toLowerCase();
            const filterJenis = document.getElementById('filterJenis').value;
            const filterKepada = document.getElementById('filterKepada').value;

            // Use onSnapshot for real-time updates
            onSnapshot(collection(db, 'artifacts', appId, 'users', userId, 'reports'), (snapshot) => {
                let laporanList = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    laporanList.push({
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp.toDate()
                    });
                });

                // Sort by newest first
                laporanList.sort((a, b) => b.timestamp - a.timestamp);

                const filteredList = laporanList.filter(entry => {
                    const data = entry.data || entry;
                    const contentText = (entry.content || '').toLowerCase();
                    const matchesSearch = searchQuery === '' ||
                        contentText.includes(searchQuery) ||
                        (data.jenis && data.jenis.toLowerCase().includes(searchQuery)) ||
                        (data.kepada && data.kepada.toLowerCase().includes(searchQuery)) ||
                        (data.pimpinan && data.pimpinan.toLowerCase().includes(searchQuery)) ||
                        (data.hasil && data.hasil.toLowerCase().includes(searchQuery));

                    const matchesJenis = filterJenis === '' || (data.jenis && data.jenis === filterJenis);
                    const matchesKepada = filterKepada === '' || (data.kepada && data.kepada === filterKepada);

                    return matchesSearch && matchesJenis && matchesKepada;
                });

                if (filteredList.length === 0) {
                    historyContainer.innerHTML = "<p>Tidak ada riwayat laporan yang cocok dengan kriteria pencarian/filter.</p>";
                    return;
                }

                historyContainer.innerHTML = filteredList.map(entry => `
                    <div class="history-item">
                        <strong>Dibuat:</strong> ${entry.timestamp.toLocaleString('id-ID', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}<br>
                        <strong>Jenis Kegiatan:</strong> ${entry.jenis || 'N/A'}<br>
                        <strong>Kepada Yth:</strong> ${entry.kepada || 'N/A'}<br>
                        <div class="history-item-buttons">
                            <button onclick="showLaporan('${entry.id}')">Lihat</button>
                            <button class="edit-btn" onclick="editLaporanById('${entry.id}')">Edit</button>
                            <button onclick="copyLaporanById('${entry.id}')">Copy</button>
                            <button onclick="downloadPDFById('${entry.id}')">PDF</button>
                            <button class="delete-btn" onclick="deleteLaporanById('${entry.id}')">Hapus</button>
                        </div>
                    </div>
                `).join("");

            }, (error) => {
                console.error("Error fetching history: ", error);
                historyContainer.innerHTML = "<p>Gagal memuat riwayat laporan.</p>";
            });
        }

        // Function to populate filter dropdowns with unique values from Firestore
        async function populateFilterOptions() {
            if (!userId) {
                console.log("User ID not available yet. Cannot populate filters.");
                return;
            }

            try {
                const querySnapshot = await getDocs(collection(db, 'artifacts', appId, 'users', userId, 'reports'));
                const jenisSet = new Set();
                const kepadaSet = new Set();
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.jenis) jenisSet.add(data.jenis);
                    if (data.kepada) kepadaSet.add(data.kepada);
                });

                const filterJenisSelect = document.getElementById('filterJenis');
                const filterKepadaSelect = document.getElementById('filterKepada');
                const currentFilterJenis = filterJenisSelect.value;
                const currentFilterKepada = filterKepadaSelect.value;

                filterJenisSelect.innerHTML = '<option value="">Semua</option>' + Array.from(jenisSet).map(jenis => `<option value="${jenis}">${jenis}</option>`).join('');
                filterKepadaSelect.innerHTML = '<option value="">Semua</option>' + Array.from(kepadaSet).map(kepada => `<option value="${kepada}">${kepada}</option>`).join('');

                filterJenisSelect.value = currentFilterJenis;
                filterKepadaSelect.value = currentFilterKepada;

            } catch (e) {
                console.error("Error populating filters: ", e);
            }
        }

        // Function to display a specific report from Firestore in the output area
        async function showLaporan(id) {
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'reports', id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    document.getElementById("reportDisplayArea").innerHTML = docSnap.data().content;
                    addWebWatermark();
                    showModal("Laporan dari riwayat ditampilkan.", 'alert');
                } else {
                    showModal("Laporan tidak ditemukan.", 'alert');
                }
            } catch (e) {
                console.error("Error fetching document: ", e);
                showModal("Gagal memuat laporan.", 'alert');
            }
        }

        // Function to populate the form for editing
        async function editLaporanById(id) {
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'reports', id);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const itemData = docSnap.data();
                    document.getElementById("jenis").value = itemData.jenis || '';
                    document.getElementById("kepada").value = itemData.kepada || 'Karo SDM Polda Banten';
                    document.getElementById("dari").value = itemData.dari || 'Kabagbinkar Ro SDM Polda Banten';
                    document.getElementById("tanggal").value = itemData.tanggal || '';
                    document.getElementById("waktu").value = itemData.waktu || '';
                    document.getElementById("tempat").value = itemData.tempat || '';
                    document.getElementById("pimpinan").value = itemData.pimpinan || '';
                    document.getElementById("hasil").value = itemData.hasil || '';
                    document.getElementById("sapaan").value = itemData.sapaan || 'Komandan';

                    const hadirContainer = document.getElementById("daftar-hadir-container");
                    hadirContainer.innerHTML = '';

                    if (itemData.peserta && itemData.peserta.length > 0) {
                        itemData.peserta.forEach(peserta => {
                            const newParticipantDiv = document.createElement("div");
                            newParticipantDiv.setAttribute('draggable', 'true');
                            newParticipantDiv.style.display = "flex";
                            newParticipantDiv.style.alignItems = "center";
                            newParticipantDiv.style.gap = "5px";

                            const input = document.createElement("input");
                            input.setAttribute("list", "daftar-hadir");
                            input.className = "hadir";
                            input.value = peserta;
                            input.style.marginBottom = "0";

                            const removeBtn = document.createElement("button");
                            removeBtn.textContent = "X";
                            removeBtn.className = "delete-participant-btn";
                            removeBtn.onclick = function() {
                                hadirContainer.removeChild(newParticipantDiv);
                            };
                            newParticipantDiv.appendChild(input);
                            newParticipantDiv.appendChild(removeBtn);
                            hadirContainer.appendChild(newParticipantDiv);
                        });
                    } else {
                        addDefaultParticipantInput();
                    }

                    document.getElementById("editingReportId").value = id;
                    document.getElementById("mainActionButton").textContent = "Simpan Perubahan";
                    document.getElementById("mainActionButton").onclick = updateLaporan;
                    document.getElementById("cancelEditButton").style.display = "inline-block";

                    showModal("Laporan siap untuk diedit. Mohon perbarui formulir.", 'alert');
                } else {
                    showModal("Laporan tidak ditemukan untuk diedit.", 'alert');
                }
            } catch (e) {
                console.error("Error fetching document for edit: ", e);
                showModal("Gagal memuat laporan untuk diedit.", 'alert');
            }
        }

        // Function to copy a specific report from Firestore
        async function copyLaporanById(id) {
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'reports', id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const temp = document.createElement("textarea");
                    temp.value = docSnap.data().content.replace(/<br>/g, '\n').replace(/<[^>]+>/g, "");
                    document.body.appendChild(temp);
                    temp.select();
                    document.execCommand("copy");
                    document.body.removeChild(temp);
                    showModal("Laporan dari riwayat berhasil disalin!", 'alert');
                } else {
                    showModal("Laporan tidak ditemukan untuk disalin.", 'alert');
                }
            } catch (e) {
                console.error("Error copying document: ", e);
                showModal("Gagal menyalin laporan.", 'alert');
            }
        }

        // Function to download a specific report from Firestore as PDF
        async function downloadPDFById(id) {
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'reports', id);
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) {
                    showModal("Laporan tidak ditemukan untuk diunduh.", 'alert');
                    return;
                }
                const item = docSnap.data();
                const printElement = document.createElement('div');
                printElement.innerHTML = item.content;
                const watermark = document.createElement('div');
                watermark.className = 'pdf-watermark';
                watermark.textContent = 'Bripda MEEP';
                printElement.appendChild(watermark);
                const pdfWatermarkStyle = document.createElement('style');
                pdfWatermarkStyle.textContent = `
                    .pdf-watermark {
                        position: absolute;
                        bottom: 20px;
                        right: 20px;
                        font-size: 12px;
                        color: rgba(0, 0, 0, 0.3);
                        font-weight: bold;
                        transform: rotate(-15deg);
                        transform-origin: 100% 100%;
                        z-index: 9999;
                    }
                `;
                printElement.appendChild(pdfWatermarkStyle);

                html2pdf().from(printElement).set({
                    margin: 0.5,
                    filename: `laporan-kegiatan-sdm-${id}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
                }).save();
            } catch (e) {
                console.error("Error downloading PDF: ", e);
                showModal("Gagal mengunduh laporan PDF.", 'alert');
            }
        }

        // Function to delete a specific report from Firestore
        function deleteLaporanById(id) {
            showModal("Yakin ingin menghapus laporan ini dari riwayat?", 'confirm', async () => {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'reports', id));
                    showModal("Laporan berhasil dihapus dari riwayat.", 'alert');
                } catch (e) {
                    console.error("Error removing document: ", e);
                    showModal("Gagal menghapus laporan: " + e.message, 'alert');
                }
            });
        }

        // Function to clear all reports from Firestore
        function clearAllHistory() {
            showModal("Yakin ingin menghapus semua riwayat laporan? Tindakan ini tidak bisa dibatalkan.", 'confirm', async () => {
                try {
                    const q = query(collection(db, 'artifacts', appId, 'users', userId, 'reports'));
                    const querySnapshot = await getDocs(q);
                    const batch = writeBatch(db);
                    querySnapshot.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    showModal("Semua riwayat laporan telah dihapus.", 'alert');
                } catch (e) {
                    console.error("Error deleting all documents: ", e);
                    showModal("Gagal menghapus semua riwayat: " + e.message, 'alert');
                }
            });
        }
        
        // --- Gemini API Integration ---
        async function elaborateHasil() {
            const jenisKegiatan = document.getElementById("jenis").value.trim();
            const hasilInput = document.getElementById("hasil").value.trim();
            const elaborateBtn = document.getElementById("elaborateHasilBtn");

            if (!jenisKegiatan || !hasilInput) {
                showModal("Mohon isi 'Jenis Kegiatan' dan 'Hasil yang Didapat' terlebih dahulu untuk memperluas.", 'alert');
                return;
            }

            elaborateBtn.disabled = true;
            const originalBtnText = elaborateBtn.innerHTML;
            elaborateBtn.innerHTML = 'Memperluas...';

            try {
                const prompt = `Perluas dan berikan detail lebih lanjut pada hasil kegiatan berikut, dengan mempertimbangkan jenis kegiatan. Gunakan bahasa formal dan profesional, cocok untuk laporan resmi Polda Banten.

Jenis Kegiatan: ${jenisKegiatan}
Hasil Singkat: ${hasilInput}

Perluasan:`;

                const payload = {
                    contents: [{ parts: [{ text: prompt }] }]
                };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    document.getElementById("hasil").value = text.trim();
                } else {
                    showModal("Gagal memperluas hasil. Respon dari AI tidak valid.", 'alert');
                    console.error("Gemini API response structure unexpected:", result);
                }
            } catch (error) {
                showModal("Terjadi kesalahan saat menghubungi AI: " + error.message, 'alert');
                console.error("Error calling Gemini API:", error);
            } finally {
                elaborateBtn.disabled = false;
                elaborateBtn.innerHTML = originalBtnText;
            }
        }

        // Function to add the web watermark to the display area
        function addWebWatermark() {
            const outputDiv = document.getElementById('output');
            let existingWatermark = outputDiv.querySelector('.web-watermark');
            if (existingWatermark) {
                existingWatermark.remove();
            }

            const watermark = document.createElement('div');
            watermark.className = 'web-watermark';
            watermark.textContent = 'Bripda MEEP';
            outputDiv.appendChild(watermark);
        }

        // Function to remove the web watermark from the display area
        function removeWebWatermark() {
            const outputDiv = document.getElementById('output');
            let existingWatermark = outputDiv.querySelector('.web-watermark');
            if (existingWatermark) {
                existingWatermark.remove();
            }
        }

        // --- Drag and Drop Logic ---
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('#daftar-hadir-container > div:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Load history and set default date when the page loads
        document.addEventListener("DOMContentLoaded", () => {
            // Set default date to today
            const tanggalInput = document.getElementById('tanggal');
            if (tanggalInput) {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                tanggalInput.value = `${year}-${month}-${day}`;
            }

            addDefaultParticipantInput();
            
            // Initialize Firebase and Auth
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-info').textContent = `Status: Terhubung | User ID: ${userId}`;
                        console.log("Authenticated with user ID: ", userId);
                        await populateFilterOptions();
                        renderHistory();
                    } else {
                        // Sign in with custom token or anonymously if not available
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase Auth Error:", error);
                            showModal("Gagal melakukan autentikasi dengan database. Silakan coba lagi.", 'alert');
                        }
                    }
                });
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                showModal("Gagal menginisialisasi database. Silakan hubungi dukungan.", 'alert');
            }

            // Drag and Drop Event Listeners
            const daftarHadirContainer = document.getElementById("daftar-hadir-container");

            daftarHadirContainer.addEventListener('dragstart', e => {
                if (e.target.closest('div[draggable="true"]')) {
                    dragSrcEl = e.target.closest('div[draggable="true"]');
                    e.dataTransfer.effectAllowed = 'move';
                    dragSrcEl.classList.add('dragging');
                }
            });

            daftarHadirContainer.addEventListener('dragover', e => {
                e.preventDefault();
                const afterElement = getDragAfterElement(daftarHadirContainer, e.clientY);
                const draggable = document.querySelector('.dragging');
                if (afterElement == null) {
                    daftarHadirContainer.appendChild(draggable);
                } else {
                    daftarHadirContainer.insertBefore(draggable, afterElement);
                }
            });

            daftarHadirContainer.addEventListener('drop', e => {
                e.preventDefault();
                document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
            });

            daftarHadirContainer.addEventListener('dragend', () => {
                document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
                dragSrcEl = null;
            });
        });

        // Expose functions to the global scope for event handlers in HTML
        window.tambahPeserta = tambahPeserta;
        window.generateLaporan = generateLaporan;
        window.updateLaporan = updateLaporan;
        window.cancelEdit = cancelEdit;
        window.downloadPDF = downloadPDF;
        window.copyLaporan = copyLaporan;
        window.hapusLaporan = hapusLaporan;
        window.renderHistory = renderHistory;
        window.showLaporan = showLaporan;
        window.editLaporanById = editLaporanById;
        window.copyLaporanById = copyLaporanById;
        window.downloadPDFById = downloadPDFById;
        window.deleteLaporanById = deleteLaporanById;
        window.clearAllHistory = clearAllHistory;
        window.elaborateHasil = elaborateHasil;
        window.showModal = showModal;
        window.hideModal = hideModal;
    </script>

</body>
</html>
